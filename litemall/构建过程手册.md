# 拼夕夕在线购物系统 - 构建过程手册

## 1. 构建概述

本手册详细说明拼夕夕在线购物系统的完整构建过程，包括后端Spring Boot应用和前端Vue应用的构建步骤、配置说明和常见问题处理。

## 2. 环境准备

### 2.1 后端环境要求

- **JDK**: Java 11
- **Maven**: 3.6.0+ 或使用IDE内置Maven
- **MySQL**: 8.0+ (数据库服务器)
- **Git**: 用于代码版本控制

### 2.2 前端环境要求

- **Node.js**: 14.x 或更高版本
- **npm**: 6.x 或更高版本 (Node.js自带)
- **Vue CLI**: 项目已包含相关依赖

## 3. 后端构建详细步骤

### 3.1 克隆代码库

```bash
# 从代码库克隆项目（示例命令）
git clone <repository-url>
cd litemall/simple-shop-backend/backend
```

### 3.2 配置数据库连接

1. 编辑 `src/main/resources/application.properties` 文件：

```properties
# 服务器端口配置
server.port=8081

# 数据库连接配置
spring.datasource.url=jdbc:mysql://localhost:3306/simple_shop?useSSL=false&serverTimezone=UTC
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=root

# JPA/Hibernate配置
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

2. 确保MySQL数据库已创建：

```sql
CREATE DATABASE simple_shop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON simple_shop.* TO 'root'@'%' IDENTIFIED BY 'root';
FLUSH PRIVILEGES;
```

### 3.3 Maven构建命令详解

在后端目录下执行以下命令：

#### 3.3.1 基本构建

```bash
# 编译并运行测试
mvn clean install

# 编译并打包（跳过测试）
mvn clean package -DskipTests

# 仅编译
mvn compile

# 运行单元测试
mvn test
```

#### 3.3.2 构建选项说明

- `-DskipTests`: 跳过测试编译和执行
- `-Dmaven.test.skip=true`: 完全跳过测试阶段
- `-P <profile>`: 使用特定的Maven配置文件
- `-X`: 开启调试输出，用于排查构建问题

#### 3.3.3 构建结果

构建成功后，会在 `target` 目录下生成以下文件：

- `simple-shop-0.0.1-SNAPSHOT.jar`: 可执行的JAR文件
- `classes/`: 编译后的类文件
- `test-classes/`: 编译后的测试类文件

## 4. 前端构建详细步骤

### 4.1 进入前端目录

```bash
cd litemall/simple-shop-frontend/frontend
```

### 4.2 安装依赖

```bash
# 安装所有依赖
npm install

# 使用淘宝镜像加速（可选）
npm install --registry=https://registry.npmmirror.com

# 安装特定依赖
npm install axios vue-router
```

### 4.3 配置API连接

编辑 `src/main.js` 文件，设置API基础URL：

```javascript
// 配置Axios基础URL
axios.defaults.baseURL = 'http://localhost:8081/api';
```

### 4.4 构建命令详解

#### 4.4.1 开发环境构建

```bash
# 开发服务器（热重载）
npm run serve

# 指定端口
npm run serve -- --port 8080

# 指定主机
npm run serve -- --host 0.0.0.0
```

#### 4.4.2 生产环境构建

```bash
# 生产环境构建（压缩优化）
npm run build

# 分析构建包大小
npm run build -- --report
```

#### 4.4.3 构建配置选项

可以在 `vue.config.js` 文件中自定义构建配置：

```javascript
module.exports = {
  // 基本路径
  publicPath: './',
  // 输出目录
  outputDir: 'dist',
  // 静态资源目录
  assetsDir: 'static',
  // 开发服务器配置
  devServer: {
    port: 8080,
    proxy: {
      '/api': {
        target: 'http://localhost:8081',
        changeOrigin: true,
        pathRewrite: {
          '^/api': '/api'
        }
      }
    }
  }
}
```

#### 4.4.4 构建结果

构建成功后，会在 `dist` 目录下生成静态文件：

- `index.html`: 应用入口文件
- `static/`: 静态资源目录（JS、CSS、图片等）

## 5. Docker构建

### 5.1 后端Docker构建

在项目根目录执行：

```bash
# 构建后端Docker镜像
docker build -f Dockerfile-backend -t simple-shop-backend .

# 运行后端容器
docker run -p 8081:8081 simple-shop-backend
```

### 5.2 前端Docker构建

```bash
# 构建前端Docker镜像
docker build -f Dockerfile-frontend -t simple-shop-frontend .

# 运行前端容器
docker run -p 80:80 simple-shop-frontend
```

### 5.3 多容器部署

```bash
# 使用docker-compose启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务日志
docker-compose logs -f
```

## 6. 构建优化与最佳实践

### 6.1 后端构建优化

- **依赖管理**：定期更新依赖版本，确保安全性
- **缓存利用**：使用Maven本地仓库缓存加速构建
- **并行构建**：使用 `-T` 参数启用并行构建
  ```bash
  mvn clean package -T 4 -DskipTests
  ```
- **分层构建**：在Dockerfile中使用多阶段构建减小镜像体积

### 6.2 前端构建优化

- **依赖分析**：使用 `npm ls` 分析依赖树，移除未使用的依赖
- **代码分割**：配置Vue Router实现路由级别的代码分割
- **资源压缩**：确保生产构建启用了JS/CSS压缩
- **CDN加速**：将第三方库配置为从CDN加载

## 7. 构建问题排查

### 7.1 后端构建常见问题

| 问题 | 可能原因 | 解决方案 |
|-----|---------|--------|
| 依赖下载失败 | 网络问题或仓库配置错误 | 配置Maven镜像源，参考`settings.xml` |
| 编译错误 | 代码语法错误或依赖版本不兼容 | 检查错误日志，修复代码或调整依赖版本 |
| 测试失败 | 测试用例问题或环境配置不正确 | 检查测试日志，修复测试或使用`-DskipTests`跳过 |
| 内存不足 | Maven构建需要更多内存 | 设置环境变量`MAVEN_OPTS=-Xmx2g -XX:MaxPermSize=512m` |

### 7.2 前端构建常见问题

| 问题 | 可能原因 | 解决方案 |
|-----|---------|--------|
| 依赖安装失败 | 网络问题或npm版本不兼容 | 清除缓存`npm cache clean --force`，使用镜像源 |
| 构建错误 | ES语法错误或依赖冲突 | 检查错误日志，修复代码或更新依赖 |
| 内存溢出 | Node.js内存不足 | 增加Node.js内存`node --max-old-space-size=4096 node_modules/@vue/cli-service/bin/vue-cli-service.js build` |
| 打包过大 | 包含未使用的依赖或资源 | 使用webpack-bundle-analyzer分析并优化 |

## 8. 自动化构建配置

### 8.1 CI/CD配置示例

对于Jenkins、GitHub Actions等CI/CD工具的配置示例：

**GitHub Actions示例** (`.github/workflows/build.yml`):

```yaml
name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Build with Maven
      working-directory: ./litemall/simple-shop-backend/backend
      run: mvn -B package --file pom.xml -DskipTests
    - name: Upload backend artifact
      uses: actions/upload-artifact@v2
      with:
        name: backend-jar
        path: litemall/simple-shop-backend/backend/target/simple-shop-0.0.1-SNAPSHOT.jar

  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14.x'
    - name: Install dependencies
      working-directory: ./litemall/simple-shop-frontend/frontend
      run: npm ci
    - name: Build
      working-directory: ./litemall/simple-shop-frontend/frontend
      run: npm run build
    - name: Upload frontend artifact
      uses: actions/upload-artifact@v2
      with:
        name: frontend-dist
        path: litemall/simple-shop-frontend/frontend/dist
```

## 9. 构建验证

构建完成后，验证应用是否正常工作：

### 9.1 后端验证

```bash
# 运行后端服务
java -jar target/simple-shop-0.0.1-SNAPSHOT.jar

# 验证API是否可访问
curl http://localhost:8081/api/health
```

### 9.2 前端验证

```bash
# 运行前端服务（开发环境）
npm run serve

# 或使用Nginx部署生产构建
# 1. 将dist目录复制到Nginx的html目录
# 2. 启动Nginx服务
# 3. 访问 http://localhost
```

## 10. 附录：构建工具配置参考

### 10.1 Maven settings.xml 示例

```xml
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                          http://maven.apache.org/xsd/settings-1.0.0.xsd">
  <mirrors>
    <mirror>
      <id>aliyunmaven</id>
      <mirrorOf>*</mirrorOf>
      <name>阿里云公共仓库</name>
      <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
  </mirrors>
  <profiles>
    <profile>
      <id>jdk-11</id>
      <activation>
        <activeByDefault>true</activeByDefault>
        <jdk>11</jdk>
      </activation>
      <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
        <maven.compiler.compilerVersion>11</maven.compiler.compilerVersion>
      </properties>
    </profile>
  </profiles>
</settings>
```

### 10.2 npm配置参考

```bash
# 设置npm镜像源
npm config set registry https://registry.npmmirror.com

# 查看npm配置
npm config list
```

### 10.3 Docker优化配置

```yaml
# docker-compose.override.yml 示例
version: '3'
services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile-backend
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: Dockerfile-frontend
    restart: unless-stopped
```

---

本手册提供了完整的构建流程指南，确保开发人员能够快速、可靠地构建和部署拼夕夕在线购物系统。如有任何构建相关问题，请参考第7节的问题排查部分或联系技术支持。