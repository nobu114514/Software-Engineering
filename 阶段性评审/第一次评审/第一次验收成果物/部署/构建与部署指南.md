# 拼夕夕在线购物系统 - 构建与部署指南

本项目是一个基于前后端分离架构的在线购物系统，后端使用Spring Boot开发，前端使用Vue 3开发。本文档提供了项目的构建、部署和运行指南。

## 1. 系统架构

- **后端**：Spring Boot 2.7.0 + JPA + MySQL
- **前端**：Vue 3 + Vue Router + Axios
- **数据库**：MySQL

## 2. 环境要求

### 2.1 后端环境

- **JDK**：Java 11或更高版本
- **Maven**：3.6.0或更高版本
- **MySQL**：8.0或更高版本

### 2.2 前端环境

- **Node.js**：14.x或更高版本
- **npm**：6.x或更高版本
- **Vue CLI**：已包含在项目依赖中

## 3. 后端构建

### 3.1 配置MySQL数据库

在开始构建前，确保MySQL数据库已安装并配置：

1. 创建数据库：
```sql
CREATE DATABASE simple_shop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. 确保root用户有足够权限：
```sql
GRANT ALL PRIVILEGES ON simple_shop.* TO 'root'@'%' IDENTIFIED BY '2004';//这里填写自己的数据库密码和用户名
FLUSH PRIVILEGES;
```

### 3.2 修改应用配置

项目已配置好默认的数据库连接信息，位于 `backend/src/main/resources/application.properties` 文件：

```properties
server.port=8081

spring.datasource.url=jdbc:mysql://localhost:3306/simple_shop?useSSL=false&serverTimezone=UTC
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=root

spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

如需修改数据库连接信息，请根据实际环境调整上述配置。

### 3.3 使用Maven构建后端

在 `backend` 目录下执行以下命令：

```bash
# 编译并打包
mvn clean package

# 跳过测试编译并打包
mvn clean package -DskipTests
```

构建成功后，会在 `backend/target` 目录下生成 `simple-shop-0.0.1-SNAPSHOT.jar` 文件。

## 4. 前端构建

### 4.1 安装依赖

在 `frontend` 目录下执行以下命令：

```bash
# 安装依赖
npm install
```

### 4.2 修改API配置

编辑 `frontend/src/main.js` 文件，确保API基础URL正确：

```javascript
// 配置Axios基础URL
axios.defaults.baseURL = 'http://localhost:8081/api';
```

### 4.3 构建前端

在 `frontend` 目录下执行以下命令：

```bash
# 开发模式运行
npm run serve

# 构建生产版本
npm run build
```

构建成功后，生产版本的文件会生成在 `frontend/dist` 目录下。

## 5. 部署（Windows环境）

### 5.1 后端部署

#### 5.1.1 使用jar包直接运行

```bash
java -jar backend/target/simple-shop-0.0.1-SNAPSHOT.jar
```

#### 5.1.2 注册为Windows服务

可以使用NSSM（Non-Sucking Service Manager）将后端应用注册为Windows服务：

1. 下载NSSM：https://nssm.cc/download
2. 解压并运行以下命令：

```cmd
nssm install SimpleShopBackend
```

在弹出的界面中设置：
- Path: 指向java.exe的完整路径
- Startup directory: 指向jar包所在目录
- Arguments: -jar simple-shop-0.0.1-SNAPSHOT.jar

然后启动服务：

```cmd
nssm start SimpleShopBackend
```

### 5.2 前端部署

#### 5.2.1 使用Nginx部署前端

1. 下载并安装Nginx：http://nginx.org/en/download.html
2. 配置Nginx（conf/nginx.conf）：

```nginx
server {
    listen 80;
    server_name localhost;

    location / {
        root path/to/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

3. 启动Nginx：双击nginx.exe或在命令行中运行

## 6. 使用Docker部署（Windows环境）

### 6.1 安装Docker Desktop

1. 下载并安装Docker Desktop for Windows：https://www.docker.com/products/docker-desktop
2. 安装完成后，确保Docker服务正在运行
3. 确保WSL 2已启用（Windows Subsystem for Linux 2），这是Docker Desktop在Windows上的推荐后端

### 6.2 配置Docker镜像加速器（解决网络问题）

由于网络原因，可能无法直接从Docker Hub下载镜像。请按照以下步骤配置镜像加速器：

1. 在Docker Desktop中点击设置（Settings）
2. 选择Docker Engine选项
3. 在配置中添加以下国内镜像加速器（阿里云为例）：

```json
{
  "registry-mirrors": [
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://reg-mirror.qiniu.com",
    "https://mirror.baidubce.com",
    "https://cr.console.aliyun.com"
  ],
  "insecure-registries": [],
  "debug": true,
  "experimental": false
}
```

4. 点击Apply & Restart重启Docker服务

### 6.3 本地预先构建JAR包

在构建Docker镜像前，建议先在本地构建JAR包，这样可以避免在Docker构建过程中再次下载依赖：

```bash
# 进入后端目录
cd simple-shop-backend/backend

# 构建JAR包（跳过测试以加快构建速度）
mvn clean package -DskipTests
```

### 6.4 Docker镜像构建说明

本项目使用特定命名的Dockerfile文件：
- `Dockerfile-backend`：用于构建后端服务镜像
- `Dockerfile-frontend`：用于构建前端服务镜像

#### 6.4.1 手动构建单个镜像

**构建后端镜像**：
```bash
docker build -t simple-shop-backend:latest -f Dockerfile-backend .
```

**构建前端镜像**：
```bash
docker build -t simple-shop-frontend:latest -f Dockerfile-frontend .
```

#### 6.4.2 镜像下载失败的替代方案

如果仍然遇到镜像下载问题，可以尝试修改Dockerfile文件中的基础镜像，使用国内镜像源：

1. 打开`Dockerfile-backend`文件
2. 将第一行改为使用阿里云镜像：
   ```dockerfile
   FROM registry.cn-hangzhou.aliyuncs.com/library/openjdk:11-jre-slim
   ```

#### 6.4.3 使用docker-compose构建所有镜像

```bash
docker-compose build
```

#### 6.4.4 镜像标签管理

为镜像添加版本标签：
```bash
docker tag simple-shop-backend:latest simple-shop-backend:1.0.0
```

### 6.5 运行Docker容器

**方法1：使用docker-compose构建并运行所有服务**
```bash
docker-compose up -d
```

**方法2：使用一键启动脚本**
直接双击运行项目根目录下的 `startup-windows.bat` 脚本，该脚本会自动检查环境并启动系统。

### 6.6 Docker镜像管理

**查看已构建的镜像**：
```bash
docker images
```

**清理未使用的镜像**：
```bash
docker image prune
```

**清理特定镜像**：
```bash
docker rmi simple-shop-backend:latest
```

### 6.7 修改Docker配置

如果需要修改Docker相关配置：
1. 编辑相应的Dockerfile或docker-compose.yml文件
2. 重新构建镜像：`docker-compose build`
3. 重启容器：`docker-compose up -d`

## 7. 系统测试

### 7.1 健康检查

后端服务启动后，可以访问以下地址检查服务状态：

```
http://localhost:8081/actuator/health
```

### 7.2 API文档

如果项目集成了Swagger，可以访问以下地址查看API文档：

```
http://localhost:8081/swagger-ui.html
```

### 7.3 前端访问

前端部署后，可以通过以下地址访问：

```
http://localhost
```

## 8. 常见问题

### 8.1 端口冲突

如果8081端口被占用，可以修改 `application.properties` 文件中的端口配置：

```properties
server.port=8082
```

### 8.2 数据库连接失败

检查数据库配置是否正确，确保MySQL服务正在运行，且用户有足够的权限。

### 8.3 跨域访问问题

如果遇到跨域访问问题，请确保 `WebConfig.java` 中的CORS配置正确。

---

本文档提供了拼夕夕在线购物系统在Windows环境下的构建和部署指南，如有问题，请联系开发团队。