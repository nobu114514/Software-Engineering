# 拼夕夕在线购物系统 - 项目升级开发说明

## 1. 升级概述

本升级方案针对拼夕夕在线购物系统进行功能增强，主要包括商品管理升级和客户系统升级两大模块。升级后的系统将支持多商品发布、多级分类管理、库存控制、商品搜索、富媒体展示以及完整的客户注册与管理功能，显著提升系统的功能性和用户体验。

## 2. 技术架构

### 2.1 整体架构

系统沿用现有的前后端分离架构，本次升级不改变基础架构模式，仅对功能模块和数据模型进行扩展：

- **后端**：基于 Spring Boot 2.7.0 框架开发，扩展 RESTful API 接口
- **前端**：采用 Vue 3 + Vue Router + Axios 技术栈，增强前端组件和页面
- **数据库**：使用 MySQL 8.0，扩展现有数据模型

### 2.2 技术栈选择

| 类别 | 技术/框架 | 版本 | 用途 | 升级说明 |
|------|-----------|------|------|----------|
| 后端框架 | Spring Boot | 2.7.0 | 提供Web应用基础框架 | 保持不变 |
| 数据访问 | Spring Data JPA | 2.7.0 | 简化数据库操作 | 保持不变 |
| 数据库 | MySQL | 8.0+ | 数据持久化存储 | 保持不变 |
| 前端框架 | Vue | 3.x | 构建用户界面 | 保持不变 |
| 前端路由 | Vue Router | - | 页面路由管理 | 保持不变 |
| HTTP客户端 | Axios | - | API请求处理 | 保持不变 |
| 富文本编辑器 | TinyMCE | 6.x | 商品描述富媒体编辑 | 新增 |
| 文件存储 | 本地文件存储 | - | 多图片存储 | 扩展现有功能 |
| 密码加密 | BCrypt | - | 用户密码安全加密 | 新增 |

## 3. 数据模型升级

### 3.1 商品分类（ProductCategory）

```java
@Entity
@Table(name = "product_categories")
public class ProductCategory {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @Column(length = 500)
    private String description;
    
    @ManyToOne
    @JoinColumn(name = "parent_id")
    private ProductCategory parentCategory; // 父分类，支持二级分类
    
    private int level; // 分类级别：1(一级分类)或2(二级分类)
    
    private LocalDateTime createdAt;
    
    private LocalDateTime updatedAt;
    
    // Getters and Setters
}
```

### 3.2 商品（Product）升级

```java
@Entity
@Table(name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @Column(columnDefinition = "TEXT") // 修改为支持长文本
    private String description;
    
    // 修改为多图片存储
    @ElementCollection
    @CollectionTable(name = "product_images", joinColumns = @JoinColumn(name = "product_id"))
    @Column(name = "image_url")
    private List<String> imageUrls = new ArrayList<>();
    
    private double price;
    
    private int stock; // 新增库存字段
    
    private boolean isActive; // 商品是否上线
    
    private boolean isFrozen; // 商品是否冻结（交易中）
    
    // 新增分类关联
    @ManyToOne
    @JoinColumn(name = "category_id")
    private ProductCategory category;
    
    private LocalDateTime createdAt;
    
    private LocalDateTime updatedAt;
    
    // Getters and Setters
    
    // 库存为0时自动下架的业务逻辑可以在Service层实现
}
```

### 3.3 客户（Customer）新增

```java
@Entity
@Table(name = "customers")
public class Customer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username; // 用户名（登录凭证）
    
    private String password; // 加密后的密码
    
    private String phone; // 电话号码
    
    private String defaultLocation; // 默认交易地点
    
    private boolean isActive; // 账户状态
    
    private LocalDateTime createdAt;
    
    private LocalDateTime updatedAt;
    
    // Getters and Setters
}
```

### 3.4 订单（Order）新增

```java
@Entity
@Table(name = "orders")
public class Order {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "customer_id")
    private Customer customer;
    
    @ManyToOne
    @JoinColumn(name = "product_id")
    private Product product;
    
    private int quantity; // 购买数量
    
    private double totalPrice; // 订单总价
    
    private String status; // 订单状态：PENDING, PAID, SHIPPED, COMPLETED, CANCELLED
    
    private String shippingAddress; // 收货地址
    
    private String contactPhone; // 联系电话
    
    private LocalDateTime createdAt;
    
    private LocalDateTime updatedAt;
    
    // Getters and Setters
}
```

## 4. 核心功能升级模块

### 4.1 商品管理升级

#### 4.1.1 批量商品发布功能

- **功能描述**：允许卖家一次上传和发布多个商品
- **实现方案**：
  - 后端新增 `ProductBatchController` 和批量处理服务
  - 支持JSON数组格式的多商品数据提交
  - 实现批量验证和错误处理机制
  - 批量操作事务管理

```java
@RestController
@RequestMapping("/api/products/batch")
public class ProductBatchController {
    // 批量创建商品
    @PostMapping
    public ResponseEntity<List<Product>> createMultipleProducts(@RequestBody List<ProductDTO> products);
    
    // 批量更新商品状态
    @PutMapping("/status")
    public ResponseEntity<List<Product>> updateProductsStatus(@RequestBody ProductBatchStatusDTO statusUpdate);
}
```

#### 4.1.2 二级类别管理

- **功能描述**：实现商品分类的二级结构管理
- **实现方案**：
  - 后端新增 `CategoryController` 和 `CategoryService`
  - 支持分类的CRUD操作
  - 前端实现分类树状展示组件
  - 商品发布时关联到具体分类

```java
@RestController
@RequestMapping("/api/categories")
public class CategoryController {
    // 获取所有一级分类
    @GetMapping
    public ResponseEntity<List<ProductCategory>> getAllCategories();
    
    // 获取指定分类及其子分类
    @GetMapping("/{id}")
    public ResponseEntity<ProductCategory> getCategoryWithChildren(@PathVariable Long id);
    
    // 创建分类
    @PostMapping
    public ResponseEntity<ProductCategory> createCategory(@RequestBody ProductCategoryDTO category);
    
    // 更新分类
    @PutMapping("/{id}")
    public ResponseEntity<ProductCategory> updateCategory(@PathVariable Long id, @RequestBody ProductCategoryDTO category);
    
    // 删除分类
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteCategory(@PathVariable Long id);
}
```

#### 4.1.3 库存管理与自动下架

- **功能描述**：为商品添加库存属性，库存为0时自动下架商品
- **实现方案**：
  - 在商品模型中增加库存字段
  - 在订单处理流程中更新库存
  - 实现库存检查和自动状态切换逻辑
  - 前端显示商品库存状态

```java
@Service
public class InventoryService {
    // 更新库存并检查是否需要下架
    public void updateInventory(Long productId, int quantity);
    
    // 检查库存是否充足
    public boolean checkInventory(Long productId, int quantity);
    
    // 自动下架库存为0的商品
    @Scheduled(fixedRate = 60000) // 每分钟执行一次
    public void autoDeactivateOutOfStockProducts();
}
```

#### 4.1.4 商品搜索功能

- **功能描述**：允许用户通过关键词搜索商品
- **实现方案**：
  - 后端实现基于商品名称、描述的全文搜索
  - 支持按分类过滤搜索结果
  - 前端实现搜索表单和搜索结果展示页面
  - 搜索结果分页和排序

```java
@RestController
@RequestMapping("/api/products")
public class ProductSearchController {
    // 搜索商品
    @GetMapping("/search")
    public ResponseEntity<Page<Product>> searchProducts(
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false) Long categoryId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String direction);
}
```

#### 4.1.5 多图片与富媒体描述

- **功能描述**：支持商品多图展示和富媒体商品描述
- **实现方案**：
  - 扩展商品模型，支持多图片存储
  - 后端实现多文件上传API
  - 前端集成富文本编辑器（TinyMCE）
  - 优化商品详情页的图片展示和富文本渲染

```java
@RestController
@RequestMapping("/api/products/{id}/images")
public class ProductImageController {
    // 上传商品图片
    @PostMapping
    public ResponseEntity<List<String>> uploadProductImages(@PathVariable Long id, @RequestParam("files") MultipartFile[] files);
    
    // 删除商品图片
    @DeleteMapping("/{imageUrl}")
    public ResponseEntity<Void> deleteProductImage(@PathVariable Long id, @PathVariable String imageUrl);
}
```

### 4.2 客户管理系统

#### 4.2.1 客户注册功能

- **功能描述**：允许客户自由注册账户
- **实现方案**：
  - 后端新增 `CustomerController` 和 `CustomerService`
  - 实现用户注册、密码加密存储
  - 前端实现注册表单和验证
  - 数据验证和错误处理

```java
@RestController
@RequestMapping("/api/customers")
public class CustomerController {
    // 客户注册
    @PostMapping("/register")
    public ResponseEntity<Customer> registerCustomer(@RequestBody CustomerRegistrationDTO registrationDTO);
    
    // 客户登录
    @PostMapping("/login")
    public ResponseEntity<JwtResponse> login(@RequestBody LoginRequest loginRequest);
}
```

#### 4.2.2 历史订单查询

- **功能描述**：客户登录后可查看历史下单记录
- **实现方案**：
  - 后端新增 `OrderController` 和 `OrderService`
  - 实现基于客户ID的订单查询
  - 前端实现订单列表和详情页面
  - 订单状态跟踪和显示

```java
@RestController
@RequestMapping("/api/customers/orders")
public class CustomerOrderController {
    // 获取当前客户的所有订单
    @GetMapping
    public ResponseEntity<Page<Order>> getCustomerOrders(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size);
    
    // 获取订单详情
    @GetMapping("/{orderId}")
    public ResponseEntity<Order> getOrderDetails(@PathVariable Long orderId);
}
```

#### 4.2.3 商家客户管理

- **功能描述**：商家可以查看所有注册客户信息和购买历史
- **实现方案**：
  - 后端新增商家客户管理API
  - 实现客户数据查询和筛选
  - 实现客户购买历史查询
  - 前端实现商家客户管理界面

```java
@RestController
@RequestMapping("/api/seller/customers")
public class SellerCustomerController {
    // 获取所有客户
    @GetMapping
    public ResponseEntity<Page<Customer>> getAllCustomers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size);
    
    // 获取客户详情
    @GetMapping("/{customerId}")
    public ResponseEntity<Customer> getCustomerDetails(@PathVariable Long customerId);
    
    // 获取客户购买历史
    @GetMapping("/{customerId}/orders")
    public ResponseEntity<Page<Order>> getCustomerPurchaseHistory(
            @PathVariable Long customerId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size);
}
```

## 5. 前端界面升级

### 5.1 商品管理界面升级

#### 5.1.1 批量商品发布页面
- 多商品表单输入界面
- 批量上传验证提示
- 导入导出功能

#### 5.1.2 分类管理界面
- 树状分类展示
- 拖拽式分类管理
- 二级分类创建和编辑表单

#### 5.1.3 商品详情与富媒体编辑
- 多图片上传和预览组件
- 富文本编辑器集成
- 库存管理界面

#### 5.1.4 商品搜索界面
- 搜索框和筛选条件
- 搜索结果分页展示
- 分类导航和过滤

### 5.2 客户系统界面

#### 5.2.1 客户注册登录界面
- 用户注册表单
- 登录界面和验证
- 密码找回功能

#### 5.2.2 客户个人中心
- 个人信息管理
- 订单历史查询
- 默认交易地点设置

#### 5.2.3 商家客户管理界面
- 客户列表和筛选
- 客户详情查看
- 购买历史分析

## 6. 数据库迁移与升级

### 6.1 数据表结构变更

需要执行以下SQL脚本进行数据库升级：

```sql
-- 创建商品分类表
CREATE TABLE product_categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(500),
    parent_id BIGINT,
    level INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES product_categories(id)
);

-- 升级商品表
ALTER TABLE products
    MODIFY description TEXT,
    ADD stock INT DEFAULT 0,
    ADD category_id BIGINT,
    ADD FOREIGN KEY (category_id) REFERENCES product_categories(id);

-- 创建商品图片表
CREATE TABLE product_images (
    product_id BIGINT NOT NULL,
    image_url VARCHAR(255) NOT NULL,
    PRIMARY KEY (product_id, image_url),
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- 创建客户表
CREATE TABLE customers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    default_location VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建订单表
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    total_price DECIMAL(10, 2) NOT NULL,
    status VARCHAR(50) NOT NULL,
    shipping_address VARCHAR(255) NOT NULL,
    contact_phone VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

### 6.2 数据迁移方案

- **商品数据迁移**：
  - 将现有商品的单个图片URL迁移到新的多图结构中
  - 为现有商品设置默认库存和分类
  - 更新商品描述为长文本格式

- **购买意向数据迁移**：
  - 可选：将现有购买意向转换为订单记录
  - 映射相关字段到新的订单表结构

## 7. 部署与升级说明

### 7.1 升级准备工作

- 备份现有数据库
- 备份现有源代码
- 安装所需的新依赖（TinyMCE等）

### 7.2 升级步骤

1. 执行数据库迁移脚本
2. 更新后端代码
3. 更新前端代码
4. 重启应用服务

### 7.3 验证测试

- 功能测试：验证所有新功能正常工作
- 兼容性测试：确保现有功能不受影响
- 性能测试：特别是批量操作和搜索功能

## 8. 安全性考虑

- **密码安全**：使用BCrypt对客户密码进行加密存储
- **访问控制**：确保客户只能访问自己的订单信息
- **输入验证**：对所有用户输入进行严格验证，防止注入攻击
- **文件上传安全**：限制商品图片的类型和大小，防止恶意文件上传
- **XSS防护**：富文本内容需要进行安全过滤，防止跨站脚本攻击

## 9. 性能优化

- **搜索优化**：为商品名称和描述字段添加索引，提高搜索性能
- **图片优化**：实现图片压缩和延迟加载
- **批量操作优化**：使用JDBC批处理提高批量操作效率
- **缓存策略**：对分类数据和热门商品实施缓存机制

## 10. 总结与展望

本次升级显著增强了拼夕夕在线购物系统的功能，特别是在商品管理和客户系统方面。升级后的系统将提供更丰富的商品展示方式、更完善的库存管理、更便捷的商品搜索以及完整的客户注册与管理功能，从而提升用户体验和系统的商业价值。

未来可以考虑的进一步优化方向包括：

- 实现购物车功能
- 集成第三方支付系统
- 添加商品评价和评分功能
- 实现推荐系统
- 增加数据分析和报表功能
- 优化移动端用户体验

系统设计保持了良好的扩展性，为后续功能升级奠定了基础。