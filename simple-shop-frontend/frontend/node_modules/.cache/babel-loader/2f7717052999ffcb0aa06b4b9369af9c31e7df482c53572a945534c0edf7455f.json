{"ast":null,"code":"export default {\n  name: 'RichTextEditor',\n  props: {\n    modelValue: {\n      type: String,\n      default: ''\n    },\n    label: {\n      type: String,\n      default: ''\n    },\n    disabled: {\n      type: Boolean,\n      default: false\n    }\n  },\n  mounted() {\n    // 初始化编辑器内容\n    if (this.modelValue) {\n      this.$refs.editorRef.innerHTML = this.modelValue;\n    }\n  },\n  watch: {\n    modelValue: {\n      handler(newVal) {\n        // 确保editorRef已初始化\n        if (this.$refs.editorRef && newVal !== this.$refs.editorRef.innerHTML) {\n          // 只有当外部传入的值与编辑器当前内容不同时才更新\n          // 避免编辑器内部修改导致的循环更新\n          this.$refs.editorRef.innerHTML = newVal;\n        }\n      },\n      immediate: true\n    }\n  },\n  methods: {\n    // 处理输入事件，直接发送内容而不重新渲染\n    onInput() {\n      const content = this.$refs.editorRef.innerHTML;\n      this.$emit('update:modelValue', content);\n    },\n    // 处理粘贴事件\n    onPaste(event) {\n      // 阻止默认粘贴行为\n      event.preventDefault();\n\n      // 获取粘贴的文本\n      const text = (event.clipboardData || window.clipboardData).getData('text/plain');\n\n      // 使用document.execCommand插入文本，保持光标位置\n      document.execCommand('insertText', false, text);\n\n      // 触发输入事件更新值\n      this.onInput();\n    },\n    // 文本格式化\n    formatText(command) {\n      try {\n        document.execCommand(command, false, null);\n        this.$refs.editorRef.focus();\n        this.onInput();\n      } catch (error) {\n        console.error('格式化文本失败:', error);\n      }\n    },\n    // 触发图片上传\n    triggerImageUpload() {\n      this.$refs.fileInput.click();\n    },\n    // 处理图片上传\n    uploadImage(event) {\n      const file = event.target.files[0];\n      if (!file) return;\n\n      // 检查文件类型\n      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\n      if (!validTypes.includes(file.type)) {\n        alert('请上传有效的图片文件（JPG、PNG、GIF、WebP）');\n        event.target.value = '';\n        return;\n      }\n\n      // 检查文件大小（限制为5MB）\n      if (file.size > 5 * 1024 * 1024) {\n        alert('图片大小不能超过5MB');\n        event.target.value = '';\n        return;\n      }\n      const formData = new FormData();\n      formData.append('files', file);\n\n      // 直接使用fetch进行上传，确保带上凭证\n      fetch('/api/files/upload/images', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include' // 确保发送cookies\n      }).then(response => {\n        console.log('上传响应状态:', response.status);\n        return response.json();\n      }).then(data => {\n        console.log('上传响应数据:', data);\n        // 检查各种可能的响应格式\n        if (data && data.imageUrls && data.imageUrls.length > 0) {\n          this.insertImageAtCursor(data.imageUrls[0]);\n        } else if (data && data.url) {\n          this.insertImageAtCursor(data.url);\n        } else {\n          alert('上传失败: ' + (data?.message || data?.error || '服务器返回格式不正确'));\n        }\n      }).catch(error => {\n        console.error('图片上传错误:', error);\n        alert('上传失败: ' + error.message);\n      }).finally(() => {\n        // 清空文件输入\n        event.target.value = '';\n      });\n    },\n    // 在光标位置插入图片\n    insertImageAtCursor(imageUrl) {\n      try {\n        const selection = window.getSelection();\n        if (!selection || selection.rangeCount === 0) {\n          // 如果没有选中区域，直接在末尾添加\n          const img = document.createElement('img');\n          img.src = imageUrl;\n          img.style.maxWidth = '100%';\n          this.$refs.editorRef.appendChild(img);\n          return;\n        }\n\n        // 获取当前选中区域\n        const range = selection.getRangeAt(0);\n\n        // 创建图片元素\n        const img = document.createElement('img');\n        img.src = imageUrl;\n        img.style.maxWidth = '100%';\n\n        // 在光标位置插入图片\n        range.deleteContents();\n        range.insertNode(img);\n\n        // 将光标移动到图片后面\n        range.setStartAfter(img);\n        range.setEndAfter(img);\n        selection.removeAllRanges();\n        selection.addRange(range);\n\n        // 更新内容并保持焦点\n        this.onInput();\n        this.$refs.editorRef.focus();\n      } catch (error) {\n        console.error('插入图片失败:', error);\n        alert('插入图片失败，请重试');\n      }\n    },\n    // 获取编辑器内容\n    getContent() {\n      return this.$refs.editorRef.innerHTML;\n    },\n    // 设置编辑器内容\n    setContent(content) {\n      this.$refs.editorRef.innerHTML = content;\n      this.$emit('update:modelValue', content);\n    },\n    // 清空编辑器\n    clear() {\n      this.$refs.editorRef.innerHTML = '';\n      this.$emit('update:modelValue', '');\n    }\n  }\n};","map":{"version":3,"names":["name","props","modelValue","type","String","default","label","disabled","Boolean","mounted","$refs","editorRef","innerHTML","watch","handler","newVal","immediate","methods","onInput","content","$emit","onPaste","event","preventDefault","text","clipboardData","window","getData","document","execCommand","formatText","command","focus","error","console","triggerImageUpload","fileInput","click","uploadImage","file","target","files","validTypes","includes","alert","value","size","formData","FormData","append","fetch","method","body","credentials","then","response","log","status","json","data","imageUrls","length","insertImageAtCursor","url","message","catch","finally","imageUrl","selection","getSelection","rangeCount","img","createElement","src","style","maxWidth","appendChild","range","getRangeAt","deleteContents","insertNode","setStartAfter","setEndAfter","removeAllRanges","addRange","getContent","setContent","clear"],"sources":["E:\\Software-Engineering\\litemall\\simple-shop-frontend\\frontend\\src\\components\\RichTextEditor.vue"],"sourcesContent":["<template>\n  <div class=\"editor-container\">\n    <label v-if=\"label\" class=\"editor-label\">{{ label }}</label>\n    <div ref=\"editorRef\" class=\"rich-text-editor\"\n         :contenteditable=\"!disabled\"\n         @input=\"onInput\"\n         @paste=\"onPaste\"></div>\n    <div class=\"toolbar\" v-if=\"!disabled\">\n      <button @click=\"formatText('bold')\" title=\"粗体\">粗体</button>\n      <button @click=\"formatText('italic')\" title=\"斜体\">斜体</button>\n      <button @click=\"formatText('underline')\" title=\"下划线\">下划线</button>\n      <button @click=\"triggerImageUpload\" title=\"插入图片\">插入图片</button>\n      <input ref=\"fileInput\" type=\"file\" accept=\"image/*\" style=\"display: none\" @change=\"uploadImage\">\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'RichTextEditor',\n  props: {\n    modelValue: {\n      type: String,\n      default: ''\n    },\n    label: {\n      type: String,\n      default: ''\n    },\n    disabled: {\n      type: Boolean,\n      default: false\n    }\n  },\n  mounted() {\n    // 初始化编辑器内容\n    if (this.modelValue) {\n      this.$refs.editorRef.innerHTML = this.modelValue\n    }\n  },\n  watch: {\n      modelValue: {\n        handler(newVal) {\n          // 确保editorRef已初始化\n          if (this.$refs.editorRef && newVal !== this.$refs.editorRef.innerHTML) {\n            // 只有当外部传入的值与编辑器当前内容不同时才更新\n            // 避免编辑器内部修改导致的循环更新\n            this.$refs.editorRef.innerHTML = newVal\n          }\n        },\n        immediate: true\n      }\n    },\n  methods: {\n    // 处理输入事件，直接发送内容而不重新渲染\n    onInput() {\n      const content = this.$refs.editorRef.innerHTML\n      this.$emit('update:modelValue', content)\n    },\n    \n    // 处理粘贴事件\n    onPaste(event) {\n      // 阻止默认粘贴行为\n      event.preventDefault()\n      \n      // 获取粘贴的文本\n      const text = (event.clipboardData || window.clipboardData).getData('text/plain')\n      \n      // 使用document.execCommand插入文本，保持光标位置\n      document.execCommand('insertText', false, text)\n      \n      // 触发输入事件更新值\n      this.onInput()\n    },\n    \n    // 文本格式化\n    formatText(command) {\n      try {\n        document.execCommand(command, false, null)\n        this.$refs.editorRef.focus()\n        this.onInput()\n      } catch (error) {\n        console.error('格式化文本失败:', error)\n      }\n    },\n    \n    // 触发图片上传\n    triggerImageUpload() {\n      this.$refs.fileInput.click()\n    },\n    \n    // 处理图片上传\n    uploadImage(event) {\n      const file = event.target.files[0]\n      if (!file) return\n      \n      // 检查文件类型\n      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']\n      if (!validTypes.includes(file.type)) {\n        alert('请上传有效的图片文件（JPG、PNG、GIF、WebP）')\n        event.target.value = ''\n        return\n      }\n      \n      // 检查文件大小（限制为5MB）\n      if (file.size > 5 * 1024 * 1024) {\n        alert('图片大小不能超过5MB')\n        event.target.value = ''\n        return\n      }\n      \n      const formData = new FormData()\n      formData.append('files', file)\n      \n      // 直接使用fetch进行上传，确保带上凭证\n      fetch('/api/files/upload/images', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include' // 确保发送cookies\n      })\n      .then(response => {\n        console.log('上传响应状态:', response.status)\n        return response.json()\n      })\n      .then(data => {\n        console.log('上传响应数据:', data)\n        // 检查各种可能的响应格式\n        if (data && data.imageUrls && data.imageUrls.length > 0) {\n          this.insertImageAtCursor(data.imageUrls[0])\n        } else if (data && data.url) {\n          this.insertImageAtCursor(data.url)\n        } else {\n          alert('上传失败: ' + (data?.message || data?.error || '服务器返回格式不正确'))\n        }\n      })\n      .catch(error => {\n        console.error('图片上传错误:', error)\n        alert('上传失败: ' + error.message)\n      })\n      .finally(() => {\n        // 清空文件输入\n        event.target.value = ''\n      })\n    },\n    \n    // 在光标位置插入图片\n    insertImageAtCursor(imageUrl) {\n      try {\n        const selection = window.getSelection()\n        if (!selection || selection.rangeCount === 0) {\n          // 如果没有选中区域，直接在末尾添加\n          const img = document.createElement('img')\n          img.src = imageUrl\n          img.style.maxWidth = '100%'\n          this.$refs.editorRef.appendChild(img)\n          return\n        }\n        \n        // 获取当前选中区域\n        const range = selection.getRangeAt(0)\n        \n        // 创建图片元素\n        const img = document.createElement('img')\n        img.src = imageUrl\n        img.style.maxWidth = '100%'\n        \n        // 在光标位置插入图片\n        range.deleteContents()\n        range.insertNode(img)\n        \n        // 将光标移动到图片后面\n        range.setStartAfter(img)\n        range.setEndAfter(img)\n        selection.removeAllRanges()\n        selection.addRange(range)\n        \n        // 更新内容并保持焦点\n        this.onInput()\n        this.$refs.editorRef.focus()\n      } catch (error) {\n        console.error('插入图片失败:', error)\n        alert('插入图片失败，请重试')\n      }\n    },\n    \n    // 获取编辑器内容\n    getContent() {\n      return this.$refs.editorRef.innerHTML\n    },\n    \n    // 设置编辑器内容\n    setContent(content) {\n      this.$refs.editorRef.innerHTML = content\n      this.$emit('update:modelValue', content)\n    },\n    \n    // 清空编辑器\n    clear() {\n      this.$refs.editorRef.innerHTML = ''\n      this.$emit('update:modelValue', '')\n    }\n  }\n}\n</script>\n\n<style scoped>\n.editor-container {\n  margin-bottom: 20px;\n}\n\n.editor-label {\n  display: block;\n  margin-bottom: 8px;\n  font-weight: 500;\n  color: #333;\n}\n\n.rich-text-editor {\n  border: 1px solid #ddd;\n  border-radius: 4px;\n  padding: 10px;\n  min-height: 200px;\n  outline: none;\n  transition: border-color 0.3s;\n}\n\n.rich-text-editor:focus {\n  border-color: #4a90e2;\n  box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);\n}\n\n.toolbar {\n  margin-top: 8px;\n  display: flex;\n  gap: 8px;\n}\n\n.toolbar button {\n  padding: 6px 12px;\n  background-color: #f5f5f5;\n  border: 1px solid #ddd;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 14px;\n  transition: all 0.3s;\n}\n\n.toolbar button:hover {\n  background-color: #e0e0e0;\n  border-color: #bbb;\n}\n\n.toolbar button:active {\n  background-color: #d0d0d0;\n}\n\n/* 确保图片在编辑器中正确显示 */\n.rich-text-editor img {\n  max-width: 100%;\n  height: auto;\n  margin: 5px 0;\n}\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}