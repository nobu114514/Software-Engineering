{"ast":null,"code":"import { toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode } from \"vue\";\nconst _hoisted_1 = {\n  class: \"editor-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"editor-label\"\n};\nconst _hoisted_3 = [\"contenteditable\"];\nconst _hoisted_4 = {\n  key: 1,\n  class: \"toolbar\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [$props.label ? (_openBlock(), _createElementBlock(\"label\", _hoisted_2, _toDisplayString($props.label), 1 /* TEXT */)) : _createCommentVNode(\"v-if\", true), _createElementVNode(\"div\", {\n    ref: \"editorRef\",\n    class: \"rich-text-editor\",\n    contenteditable: !$props.disabled,\n    onInput: _cache[0] || (_cache[0] = (...args) => $options.onInput && $options.onInput(...args)),\n    onPaste: _cache[1] || (_cache[1] = (...args) => $options.onPaste && $options.onPaste(...args))\n  }, null, 40 /* PROPS, NEED_HYDRATION */, _hoisted_3), !$props.disabled ? (_openBlock(), _createElementBlock(\"div\", _hoisted_4, [_createElementVNode(\"button\", {\n    onClick: _cache[2] || (_cache[2] = $event => $options.formatText('bold')),\n    title: \"粗体\"\n  }, \"粗体\"), _createElementVNode(\"button\", {\n    onClick: _cache[3] || (_cache[3] = $event => $options.formatText('italic')),\n    title: \"斜体\"\n  }, \"斜体\"), _createElementVNode(\"button\", {\n    onClick: _cache[4] || (_cache[4] = $event => $options.formatText('underline')),\n    title: \"下划线\"\n  }, \"下划线\"), _createElementVNode(\"button\", {\n    onClick: _cache[5] || (_cache[5] = (...args) => $options.triggerImageUpload && $options.triggerImageUpload(...args)),\n    title: \"插入图片\"\n  }, \"插入图片\"), _createElementVNode(\"input\", {\n    ref: \"fileInput\",\n    type: \"file\",\n    accept: \"image/*\",\n    style: {\n      \"display\": \"none\"\n    },\n    onChange: _cache[6] || (_cache[6] = (...args) => $options.uploadImage && $options.uploadImage(...args))\n  }, null, 544 /* NEED_HYDRATION, NEED_PATCH */)])) : _createCommentVNode(\"v-if\", true)]);\n}","map":{"version":3,"names":["class","_createElementBlock","_hoisted_1","$props","label","_hoisted_2","_toDisplayString","_createElementVNode","ref","contenteditable","disabled","onInput","_cache","args","$options","onPaste","_hoisted_4","onClick","$event","formatText","title","triggerImageUpload","type","accept","style","onChange","uploadImage"],"sources":["E:\\Software-Engineering\\litemall\\simple-shop-frontend\\frontend\\src\\components\\RichTextEditor.vue"],"sourcesContent":["<template>\n  <div class=\"editor-container\">\n    <label v-if=\"label\" class=\"editor-label\">{{ label }}</label>\n    <div ref=\"editorRef\" class=\"rich-text-editor\"\n         :contenteditable=\"!disabled\"\n         @input=\"onInput\"\n         @paste=\"onPaste\"></div>\n    <div class=\"toolbar\" v-if=\"!disabled\">\n      <button @click=\"formatText('bold')\" title=\"粗体\">粗体</button>\n      <button @click=\"formatText('italic')\" title=\"斜体\">斜体</button>\n      <button @click=\"formatText('underline')\" title=\"下划线\">下划线</button>\n      <button @click=\"triggerImageUpload\" title=\"插入图片\">插入图片</button>\n      <input ref=\"fileInput\" type=\"file\" accept=\"image/*\" style=\"display: none\" @change=\"uploadImage\">\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'RichTextEditor',\n  props: {\n    modelValue: {\n      type: String,\n      default: ''\n    },\n    label: {\n      type: String,\n      default: ''\n    },\n    disabled: {\n      type: Boolean,\n      default: false\n    }\n  },\n  mounted() {\n    // 初始化编辑器内容\n    if (this.modelValue) {\n      this.$refs.editorRef.innerHTML = this.modelValue\n    }\n  },\n  watch: {\n      modelValue: {\n        handler(newVal) {\n          // 确保editorRef已初始化\n          if (this.$refs.editorRef && newVal !== this.$refs.editorRef.innerHTML) {\n            // 只有当外部传入的值与编辑器当前内容不同时才更新\n            // 避免编辑器内部修改导致的循环更新\n            this.$refs.editorRef.innerHTML = newVal\n          }\n        },\n        immediate: true\n      }\n    },\n  methods: {\n    // 处理输入事件，直接发送内容而不重新渲染\n    onInput() {\n      const content = this.$refs.editorRef.innerHTML\n      this.$emit('update:modelValue', content)\n    },\n    \n    // 处理粘贴事件\n    onPaste(event) {\n      // 阻止默认粘贴行为\n      event.preventDefault()\n      \n      // 获取粘贴的文本\n      const text = (event.clipboardData || window.clipboardData).getData('text/plain')\n      \n      // 使用document.execCommand插入文本，保持光标位置\n      document.execCommand('insertText', false, text)\n      \n      // 触发输入事件更新值\n      this.onInput()\n    },\n    \n    // 文本格式化\n    formatText(command) {\n      try {\n        document.execCommand(command, false, null)\n        this.$refs.editorRef.focus()\n        this.onInput()\n      } catch (error) {\n        console.error('格式化文本失败:', error)\n      }\n    },\n    \n    // 触发图片上传\n    triggerImageUpload() {\n      this.$refs.fileInput.click()\n    },\n    \n    // 处理图片上传\n    uploadImage(event) {\n      const file = event.target.files[0]\n      if (!file) return\n      \n      // 检查文件类型\n      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']\n      if (!validTypes.includes(file.type)) {\n        alert('请上传有效的图片文件（JPG、PNG、GIF、WebP）')\n        event.target.value = ''\n        return\n      }\n      \n      // 检查文件大小（限制为5MB）\n      if (file.size > 5 * 1024 * 1024) {\n        alert('图片大小不能超过5MB')\n        event.target.value = ''\n        return\n      }\n      \n      const formData = new FormData()\n      formData.append('files', file)\n      \n      // 尝试获取认证token，如果有的话\n      const token = localStorage.getItem('token') || sessionStorage.getItem('token')\n      \n      // 配置请求头部\n      const headers = {}\n      if (token) {\n        headers['Authorization'] = `Bearer ${token}`\n      }\n      \n      console.log('开始上传图片，目标URL:', '/api/files/upload/images')\n      console.log('认证token是否存在:', !!token)\n      \n      // 直接使用fetch进行上传，确保带上凭证\n      fetch('/api/files/upload/images', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include', // 确保发送cookies\n        headers: headers\n      })\n      .then(response => {\n        console.log('上传响应状态:', response.status)\n        console.log('响应内容类型:', response.headers.get('content-type'))\n        \n        // 先获取原始响应文本，以便在非JSON情况下查看\n        return response.text().then(text => {\n          console.log('原始响应内容:', text.substring(0, 100) + '...') // 只显示前100个字符\n          \n          // 尝试解析JSON\n          try {\n            return JSON.parse(text)\n          } catch (e) {\n            // 如果解析失败，创建错误对象\n            throw new Error(`非JSON响应: ${text.substring(0, 200)}...`)\n          }\n        })\n      })\n      .then(data => {\n        console.log('上传响应数据格式:', Object.keys(data))\n        // 检查各种可能的响应格式\n        if (data && data.imageUrls && data.imageUrls.length > 0) {\n          this.insertImageAtCursor(data.imageUrls[0])\n        } else if (data && data.url) {\n          this.insertImageAtCursor(data.url)\n        } else if (data && data.data && data.data.imageUrls && data.data.imageUrls.length > 0) {\n          this.insertImageAtCursor(data.data.imageUrls[0])\n        } else {\n          console.error('未预期的响应格式:', data)\n          alert('上传失败: 服务器返回格式不正确')\n        }\n      })\n      .catch(error => {\n        console.error('图片上传错误:', error)\n        // 更友好的错误提示\n        if (error.message.includes('Unexpected token')) {\n          alert('上传失败: 服务器返回HTML内容而非JSON，请检查API路径是否正确或服务器状态')\n        } else {\n          alert('上传失败: ' + error.message)\n        }\n      })\n      .finally(() => {\n        // 清空文件输入\n        event.target.value = ''\n      })\n    },\n    \n    // 在光标位置插入图片\n    insertImageAtCursor(imageUrl) {\n      try {\n        const selection = window.getSelection()\n        if (!selection || selection.rangeCount === 0) {\n          // 如果没有选中区域，直接在末尾添加\n          const img = document.createElement('img')\n          img.src = imageUrl\n          img.style.maxWidth = '100%'\n          this.$refs.editorRef.appendChild(img)\n          return\n        }\n        \n        // 获取当前选中区域\n        const range = selection.getRangeAt(0)\n        \n        // 创建图片元素\n        const img = document.createElement('img')\n        img.src = imageUrl\n        img.style.maxWidth = '100%'\n        \n        // 在光标位置插入图片\n        range.deleteContents()\n        range.insertNode(img)\n        \n        // 将光标移动到图片后面\n        range.setStartAfter(img)\n        range.setEndAfter(img)\n        selection.removeAllRanges()\n        selection.addRange(range)\n        \n        // 更新内容并保持焦点\n        this.onInput()\n        this.$refs.editorRef.focus()\n      } catch (error) {\n        console.error('插入图片失败:', error)\n        alert('插入图片失败，请重试')\n      }\n    },\n    \n    // 获取编辑器内容\n    getContent() {\n      return this.$refs.editorRef.innerHTML\n    },\n    \n    // 设置编辑器内容\n    setContent(content) {\n      this.$refs.editorRef.innerHTML = content\n      this.$emit('update:modelValue', content)\n    },\n    \n    // 清空编辑器\n    clear() {\n      this.$refs.editorRef.innerHTML = ''\n      this.$emit('update:modelValue', '')\n    }\n  }\n}\n</script>\n\n<style scoped>\n.editor-container {\n  margin-bottom: 20px;\n}\n\n.editor-label {\n  display: block;\n  margin-bottom: 8px;\n  font-weight: 500;\n  color: #333;\n}\n\n.rich-text-editor {\n  border: 1px solid #ddd;\n  border-radius: 4px;\n  padding: 10px;\n  min-height: 200px;\n  outline: none;\n  transition: border-color 0.3s;\n}\n\n.rich-text-editor:focus {\n  border-color: #4a90e2;\n  box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);\n}\n\n.toolbar {\n  margin-top: 8px;\n  display: flex;\n  gap: 8px;\n}\n\n.toolbar button {\n  padding: 6px 12px;\n  background-color: #f5f5f5;\n  border: 1px solid #ddd;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 14px;\n  transition: all 0.3s;\n}\n\n.toolbar button:hover {\n  background-color: #e0e0e0;\n  border-color: #bbb;\n}\n\n.toolbar button:active {\n  background-color: #d0d0d0;\n}\n\n/* 确保图片在编辑器中正确显示 */\n.rich-text-editor img {\n  max-width: 100%;\n  height: auto;\n  margin: 5px 0;\n}\n</style>"],"mappings":";;EACOA,KAAK,EAAC;AAAkB;;;EACPA,KAAK,EAAC;;;;;EAKrBA,KAAK,EAAC;;;uBANbC,mBAAA,CAaM,OAbNC,UAaM,GAZSC,MAAA,CAAAC,KAAK,I,cAAlBH,mBAAA,CAA4D,SAA5DI,UAA4D,EAAAC,gBAAA,CAAhBH,MAAA,CAAAC,KAAK,oB,mCACjDG,mBAAA,CAG4B;IAHvBC,GAAG,EAAC,WAAW;IAACR,KAAK,EAAC,kBAAkB;IACvCS,eAAe,GAAGN,MAAA,CAAAO,QAAQ;IAC1BC,OAAK,EAAAC,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEC,QAAA,CAAAH,OAAA,IAAAG,QAAA,CAAAH,OAAA,IAAAE,IAAA,CAAO;IACdE,OAAK,EAAAH,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEC,QAAA,CAAAC,OAAA,IAAAD,QAAA,CAAAC,OAAA,IAAAF,IAAA,CAAO;yDACQV,MAAA,CAAAO,QAAQ,I,cAApCT,mBAAA,CAMM,OANNe,UAMM,GALJT,mBAAA,CAA0D;IAAjDU,OAAK,EAAAL,MAAA,QAAAA,MAAA,MAAAM,MAAA,IAAEJ,QAAA,CAAAK,UAAU;IAAUC,KAAK,EAAC;KAAK,IAAE,GACjDb,mBAAA,CAA4D;IAAnDU,OAAK,EAAAL,MAAA,QAAAA,MAAA,MAAAM,MAAA,IAAEJ,QAAA,CAAAK,UAAU;IAAYC,KAAK,EAAC;KAAK,IAAE,GACnDb,mBAAA,CAAiE;IAAxDU,OAAK,EAAAL,MAAA,QAAAA,MAAA,MAAAM,MAAA,IAAEJ,QAAA,CAAAK,UAAU;IAAeC,KAAK,EAAC;KAAM,KAAG,GACxDb,mBAAA,CAA8D;IAArDU,OAAK,EAAAL,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEC,QAAA,CAAAO,kBAAA,IAAAP,QAAA,CAAAO,kBAAA,IAAAR,IAAA,CAAkB;IAAEO,KAAK,EAAC;KAAO,MAAI,GACrDb,mBAAA,CAAgG;IAAzFC,GAAG,EAAC,WAAW;IAACc,IAAI,EAAC,MAAM;IAACC,MAAM,EAAC,SAAS;IAACC,KAAqB,EAArB;MAAA;IAAA,CAAqB;IAAEC,QAAM,EAAAb,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEC,QAAA,CAAAY,WAAA,IAAAZ,QAAA,CAAAY,WAAA,IAAAb,IAAA,CAAW","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}