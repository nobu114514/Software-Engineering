# Docker容器连接问题解决方案

本文档提供了在使用Docker运行Simple Shop应用时可能遇到的连接问题及解决方法。

## 常见连接问题

### 1. 无法连接到后端服务

**问题现象：**
- 前端页面显示无法连接到服务器
- 控制台报错"Connection refused"或"Failed to load resource"

**解决方法：**

1. **检查后端服务是否正常运行**
   ```bash
   docker ps
   # 确认simple-shop-backend容器状态为Up
   ```

2. **查看后端服务日志**
   ```bash
   docker logs simple-shop-backend
   # 检查是否有错误信息
   ```

3. **确认端口映射正确**
   - 确保Dockerfile-backend中的EXPOSE端口与docker-compose.yml中的端口映射一致
   - 默认配置下，后端服务应映射到8081端口

4. **检查防火墙设置**
   - 确保Windows防火墙允许8081端口的入站连接
   - 临时关闭防火墙测试是否能连接

### 2. 数据库连接失败

**问题现象：**
- 后端服务启动失败
- 日志显示数据库连接错误

**解决方法：**

1. **检查数据库容器状态**
   ```bash
   docker ps
   # 确认数据库容器是否正常运行
   ```

2. **验证数据库连接参数**
   - 检查应用配置中的数据库URL、用户名和密码是否正确
   - 默认配置通常使用：
     - URL: jdbc:mysql://mysql:3306/simple_shop
     - 用户名: root
     - 密码: root

3. **检查网络配置**
   - 确保应用容器和数据库容器在同一个Docker网络中
   - 在docker-compose.yml中检查网络配置

### 3. 使用官方镜像拉取慢或失败

**问题现象：**
- Docker拉取镜像时速度极慢
- 拉取镜像超时失败

**解决方法：**

1. **提前下载所需镜像**
   - 在有网络条件的环境中，提前下载所需的Docker镜像：
   ```bash
   # 下载官方OpenJDK 11镜像
   docker pull openjdk:11-jre-slim
   
   # 下载可能需要的其他镜像（根据docker-compose.yml中的配置）
   # 例如MySQL镜像
   docker pull mysql:8.0
   # 例如Nginx镜像
   docker pull nginx:alpine
   ```
   - 保存镜像为本地文件（便于在其他环境中使用）：
   ```bash
   docker save -o openjdk-11-jre-slim.tar openjdk:11-jre-slim
   # 可选：其他镜像
   docker save -o mysql-8.0.tar mysql:8.0
   docker save -o nginx-alpine.tar nginx:alpine
   ```
   - 在目标环境中加载镜像：
   ```bash
   docker load -i openjdk-11-jre-slim.tar
   # 可选：其他镜像
   docker load -i mysql-8.0.tar
   docker load -i nginx-alpine.tar
   ```

2. **使用国内镜像源加速**
   - 可以修改Docker配置，添加国内镜像源
   - 在Docker Desktop中，进入Settings > Docker Engine，添加：
   ```json
   {
     "registry-mirrors": [
       "https://registry.docker-cn.com",
       "https://mirror.baidubce.com",
       "https://hub-mirror.c.163.com"
     ]
   }
   ```

3. **手动修改Dockerfile使用国内镜像源**
   - 如需改回阿里云镜像源，可以编辑Dockerfile-backend，将：
   ```dockerfile
   FROM openjdk:11-jre-slim
   ```
   修改为：
   ```dockerfile
   FROM registry.cn-hangzhou.aliyuncs.com/library/openjdk:11-jre-slim
   ```

### 4. 容器间网络通信问题

**问题现象：**
- 前端容器无法连接到后端容器
- 容器间无法通过服务名解析

**解决方法：**

1. **检查Docker网络**
   ```bash
   docker network ls
   docker network inspect <network_name>
   ```

2. **确保容器在同一网络**
   - 在docker-compose.yml中，确保所有服务都使用相同的网络配置

3. **使用正确的服务名**
   - 容器间通信应使用docker-compose中定义的服务名作为主机名
   - 例如：前端访问后端应使用http://backend:8081而不是localhost:8081

## 排查步骤

1. **检查所有容器状态**
   ```bash
   docker-compose ps
   ```

2. **查看所有容器日志**
   ```bash
   docker-compose logs
   ```

3. **测试网络连接**
   ```bash
   # 进入容器内部测试连接
   docker exec -it simple-shop-frontend sh
   # 安装ping工具（如果需要）
   apt-get update && apt-get install -y iputils-ping
   # 测试连接后端
   ping backend
   curl http://backend:8081
   ```

4. **重启Docker服务**
   - 在Windows上，可以重启Docker Desktop
   - 或使用命令：
   ```bash
   net stop com.docker.service
   net start com.docker.service
   ```

## 其他常见问题

### Windows系统特殊注意事项

1. **路径分隔符问题**
   - Windows使用反斜杠(\)，而Docker使用正斜杠(/)
   - 在挂载卷时需特别注意格式

2. **文件权限问题**
   - Windows文件权限与Linux不同
   - 确保挂载的卷有适当的读写权限

3. **WSL2相关问题**
   - 如果使用WSL2后端，检查WSL2状态
   - 可以尝试重启WSL2：
   ```bash
   wsl --shutdown
   wsl
   ```

如有其他未解决的连接问题，请检查系统防火墙设置、网络代理配置或咨询系统管理员。