# 拼夕夕在线购物系统 - 构建配置文件说明

本文档详细说明了拼夕夕在线购物系统中所有构建相关的配置文件结构、参数含义和自定义方法。

## 1. 后端构建配置

### 1.1 Maven POM文件 (`pom.xml`)

**路径**: `simple-shop-backend/backend/pom.xml`

**主要配置项**:

```xml
<!-- 项目基本信息 -->
<groupId>com.shop</groupId>
<artifactId>simple-shop</artifactId>
<version>0.0.1-SNAPSHOT</version>
<name>simple-shop</name>
<description>拼夕夕在线购物系统</description>

<!-- 属性配置 -->
<properties>
    <java.version>11</java.version>
    <!-- 测试相关版本锁定 -->
    <junit.version>5.8.2</junit.version>
    <assertj.version>3.23.1</assertj.version>
    <webdrivermanager.version>5.5.3</webdrivermanager.version>
    <selenium.version>4.33.0</selenium.version>
</properties>
```

**关键依赖说明**:

| 依赖 | 版本 | 用途 |
|-----|-----|------|
| spring-boot-starter-data-jpa | Spring Boot 2.7.0 | JPA数据访问支持 |
| spring-boot-starter-web | Spring Boot 2.7.0 | Web应用支持 |
| spring-boot-starter-actuator | Spring Boot 2.7.0 | 应用监控支持 |
| mysql-connector-java | Spring Boot管理版本 | MySQL数据库驱动 |
| junit-jupiter-api/engine | 5.8.2 | JUnit 5测试框架 |
| selenium-java | 4.33.0 | Selenium自动化测试 |

**自定义构建配置**: 如需添加其他依赖或插件，可在pom.xml中相应部分添加。

### 1.2 应用配置文件 (`application.properties`)

**路径**: `simple-shop-backend/backend/src/main/resources/application.properties`

**主要配置项**:

```properties
# 服务器配置
server.port=8081

# 数据库连接配置
spring.datasource.url=jdbc:mysql://localhost:3306/simple_shop?useSSL=false&serverTimezone=UTC
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.username=root
spring.datasource.password=root

# JPA/Hibernate配置
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

**自定义配置**: 根据实际部署环境，可以修改数据库连接信息、端口号等。

## 2. 前端构建配置

### 2.1 Vue配置文件 (`vue.config.js`)

**路径**: `simple-shop-frontend/frontend/vue.config.js`

**推荐配置**:

```javascript
module.exports = {
  // 基本路径，生产环境使用相对路径
  publicPath: process.env.NODE_ENV === 'production' ? './' : '/',
  
  // 输出目录
  outputDir: 'dist',
  
  // 静态资源目录
  assetsDir: 'static',
  
  // 生产环境是否生成sourceMap
  productionSourceMap: false,
  
  // webpack-dev-server配置
  devServer: {
    // 端口号
    port: 8080,
    
    // 主机名，允许外部访问
    host: '0.0.0.0',
    
    // 启动时自动打开浏览器
    open: true,
    
    // 代理配置，解决跨域问题
    proxy: {
      '/api': {
        // 后端API地址
        target: 'http://localhost:8081',
        // 允许跨域
        changeOrigin: true,
        // 路径重写
        pathRewrite: {
          '^/api': '/api'
        }
      }
    },
    
    // 错误提示
    overlay: {
      warnings: false,
      errors: true
    }
  },
  
  // webpack配置
  configureWebpack: {
    // 性能配置
    performance: {
      // 入口起点的最大体积
      maxEntrypointSize: 512000,
      // 生成文件的最大体积
      maxAssetSize: 512000
    },
    
    // 优化配置
    optimization: {
      // 分割代码
      splitChunks: {
        chunks: 'all',
        cacheGroups: {
          // 分割第三方依赖
          vendors: {
            name: 'chunk-vendors',
            test: /[\\/]node_modules[\\/]/,
            priority: -10,
            chunks: 'initial'
          },
          // 分割公共组件
          common: {
            name: 'chunk-common',
            minChunks: 2,
            priority: -20,
            chunks: 'initial',
            reuseExistingChunk: true
          }
        }
      }
    }
  }
}
```

### 2.2 Babel配置文件 (`babel.config.js`)

**路径**: `simple-shop-frontend/frontend/babel.config.js`

**推荐配置**:

```javascript
module.exports = {
  presets: [
    // Vue CLI推荐的Babel预设
    '@vue/cli-plugin-babel/preset'
  ],
  
  // 可选：配置插件
  plugins: [
    // 如有需要，添加其他Babel插件
  ]
}
```

### 2.3 前端package.json配置

**路径**: `simple-shop-frontend/frontend/package.json`

**主要配置项**:

```json
{
  "scripts": {
    "serve": "vue-cli-service serve",
    "build": "vue-cli-service build",
    "lint": "vue-cli-service lint",
    "build:report": "vue-cli-service build --report"
  },
  "dependencies": {
    "vue": "^3.2.13",
    "vue-router": "^4.0.3",
    "axios": "^0.24.0"
    
  },
  "devDependencies": {
    
  }
}
```

**自定义脚本**: 可以根据需要添加自定义构建脚本。

## 3. Docker构建配置

### 3.1 后端Dockerfile (`Dockerfile-backend`)

**路径**: `litemall/Dockerfile-backend`

**当前配置**:

```dockerfile
# 使用官方OpenJDK 11
FROM openjdk:11-jre-slim

# 设置维护者信息
LABEL maintainer="Simple Shop Team <team@simpleshop.com>"

# 创建工作目录
WORKDIR /app

# 设置环境变量
ENV JAVA_OPTS="-Xms256m -Xmx512m"

# 复制jar文件到容器中 - 修复路径
COPY simple-shop-backend/backend/target/simple-shop-0.0.1-SNAPSHOT.jar app.jar

# 暴露服务端口
EXPOSE 8081

# 启动命令
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

**自定义配置**:

- 可以调整JVM参数：`ENV JAVA_OPTS="-Xms512m -Xmx1024m"`
- 可以添加健康检查：`HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://localhost:8081/api/health || exit 1`

### 3.2 前端Dockerfile (`Dockerfile-frontend`)

**路径**: `litemall/Dockerfile-frontend`

**推荐配置**:

```dockerfile
# 阶段1：构建前端
FROM node:14-alpine as builder

# 设置工作目录
WORKDIR /app

# 复制package.json和package-lock.json
COPY simple-shop-frontend/frontend/package*.json ./

# 安装依赖
RUN npm install --registry=https://registry.npmmirror.com

# 复制所有文件
COPY simple-shop-frontend/frontend/ .

# 构建前端
RUN npm run build

# 阶段2：部署到Nginx
FROM nginx:alpine

# 复制构建产物到Nginx
COPY --from=builder /app/dist/ /usr/share/nginx/html/

# 复制自定义Nginx配置
COPY frontend/nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### 3.3 Nginx配置文件 (`nginx.conf`)

**路径**: `litemall/frontend/nginx.conf`

**推荐配置**:

```nginx
server {
    listen 80;
    server_name localhost;

    # 静态资源配置
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    # API代理配置
    location /api/ {
        proxy_pass http://backend:8081/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 错误页面
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        root /usr/share/nginx/html;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
}
```

### 3.4 Docker Compose配置 (`docker-compose.yml`)

**路径**: `litemall/docker-compose.yml`

**推荐配置**:

```yaml
version: '3.8'

services:
  # 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile-backend
    container_name: simple-shop-backend
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/simple_shop?useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - mysql
    networks:
      - simple-shop-network

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile-frontend
    container_name: simple-shop-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - simple-shop-network

  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: simple-shop-mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      - MYSQL_DATABASE=simple_shop
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - simple-shop-network

# 网络配置
networks:
  simple-shop-network:
    driver: bridge

# 数据卷配置
volumes:
  mysql-data:
    driver: local
```

## 4. 构建脚本配置

### 4.1 自动构建脚本 (`build-all.bat`)

**路径**: `litemall/build-all.bat`

**主要配置项**:

- **环境检查**：自动检查Java、Maven、Node.js环境
- **构建选项**：可通过设置环境变量控制构建行为
  - `SKIP_FRONTEND=true`: 跳过前端构建
- **日志输出**：构建日志保存在`logs/`目录

### 4.2 启动脚本配置

项目中现有的启动脚本包括：

- `start-all.bat`: 启动所有服务
- `start-backend.bat`: 启动后端服务
- `start-frontend.bat`: 启动前端服务
- `startup-windows.bat`: Windows启动脚本

**自定义启动参数**:

可以根据需要修改这些脚本，添加启动参数或环境变量。

## 5. 环境变量配置

### 5.1 后端环境变量

Spring Boot支持通过环境变量覆盖`application.properties`中的配置：

| 配置项 | 环境变量名 | 默认值 |
|-------|-----------|-------|
| 服务器端口 | SERVER_PORT | 8081 |
| 数据库URL | SPRING_DATASOURCE_URL | jdbc:mysql://localhost:3306/simple_shop... |
| 数据库用户名 | SPRING_DATASOURCE_USERNAME | root |
| 数据库密码 | SPRING_DATASOURCE_PASSWORD | root |
| JPA DDL模式 | SPRING_JPA_HIBERNATE_DDL_AUTO | update |

### 5.2 前端环境变量

前端支持通过`.env`文件设置环境变量：

**创建`.env`文件**:

```dotenv
# 基础环境变量
VUE_APP_API_BASE_URL=http://localhost:8081/api
VUE_APP_APP_NAME=拼夕夕在线购物系统
VUE_APP_DEBUG=false
```

**创建`.env.production`文件**:

```dotenv
# 生产环境变量
VUE_APP_API_BASE_URL=http://api.example.com/api
VUE_APP_DEBUG=false
```

## 6. 构建配置优化建议

### 6.1 后端构建优化

1. **依赖管理**
   - 使用`<dependencyManagement>`统一管理版本
   - 定期更新依赖版本以获取安全修复

2. **构建插件配置**
   - 添加Spring Boot Maven插件的自定义配置
   ```xml
   <plugin>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-maven-plugin</artifactId>
     <configuration>
       <mainClass>com.shop.SimpleShopApplication</mainClass>
       <layout>JAR</layout>
     </configuration>
   </plugin>
   ```

3. **资源过滤**
   - 根据环境过滤配置文件
   ```xml
   <resources>
     <resource>
       <directory>src/main/resources</directory>
       <filtering>true</filtering>
     </resource>
   </resources>
   ```

### 6.2 前端构建优化

1. **缓存优化**
   - 配置webpack的文件名哈希策略
   - 启用长期缓存

2. **代码分割**
   - 配置Vue Router的懒加载
   ```javascript
   const Home = () => import('@/views/Home.vue')
   ```

3. **CDN配置**
   - 将第三方库配置为从CDN加载
   ```javascript
   configureWebpack: {
     externals: {
       'vue': 'Vue',
       'vue-router': 'VueRouter'
     }
   }
   ```

### 6.3 Docker构建优化

1. **多阶段构建**
   - 使用多阶段构建减小镜像体积
   - 分离构建环境和运行环境

2. **镜像层优化**
   - 合并RUN命令减少层数
   - 合理排序Dockerfile指令以利用缓存

3. **资源限制**
   - 在docker-compose.yml中配置容器资源限制
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '1'
         memory: 1G
   ```

## 7. 附录：配置文件模板

### 7.1 Maven settings.xml模板

```xml
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                          http://maven.apache.org/xsd/settings-1.0.0.xsd">
  <mirrors>
    <!-- 阿里云Maven镜像 -->
    <mirror>
      <id>aliyunmaven</id>
      <mirrorOf>*</mirrorOf>
      <name>阿里云公共仓库</name>
      <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
  </mirrors>
  
  <profiles>
    <profile>
      <id>jdk-11</id>
      <activation>
        <activeByDefault>true</activeByDefault>
        <jdk>11</jdk>
      </activation>
      <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
      </properties>
    </profile>
  </profiles>
</settings>
```

### 7.2 npm配置模板

在用户目录下创建`.npmrc`文件：

```
# 淘宝镜像
registry=https://registry.npmmirror.com/

# 保存时自动创建package-lock.json
package-lock=true

# 安装时使用legacy-peer-deps模式
legacy-peer-deps=true

# 缓存目录
cache=D:\npm-cache
```

---

本文档提供了拼夕夕在线购物系统所有构建配置文件的详细说明和优化建议。开发人员可以根据实际需求和环境特点，参考本文档自定义和优化构建配置。